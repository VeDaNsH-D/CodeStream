<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Code Stream</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs/loader.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #1e1e1e; }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
        
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #4a4a52; border-radius: 4px; }
        .panel-content-box { background-color: rgba(0, 0, 0, 0.2); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 6px; height: 100%; overflow-y: auto; }
    </style>
</head>
<body class="bg-[#1e1e1e] text-gray-200 overflow-hidden">

    <div id="entry-modal" class="fixed inset-0 bg-black/70 flex items-center justify-center z-50">
        <div class="bg-[#252526] border border-blue-500/30 p-8 rounded-lg shadow-2xl w-full max-w-md">
            <h2 class="text-2xl font-bold text-center text-white mb-6">Code Stream</h2>
            <div class="space-y-4">
                <input id="username-input" type="text" placeholder="Enter your name" class="w-full bg-[#3c4043] border border-gray-600 rounded-md px-4 py-2 text-white focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
                <button id="create-room-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md transition duration-200">Create New Room</button>
                <div class="relative"><div class="absolute inset-0 flex items-center"><div class="w-full border-t border-gray-700"></div></div><div class="relative flex justify-center text-sm"><span class="bg-[#252526] px-2 text-gray-400">or</span></div></div>
                <div class="flex space-x-2">
                    <input id="room-id-input" type="text" placeholder="Enter Room ID" class="w-full bg-[#3c4043] border border-gray-600 rounded-md px-4 py-2 text-white focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
                    <button id="join-room-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md transition">Join</button>
                </div>
            </div>
        </div>
    </div>

    <div id="app" class="hidden h-screen w-screen flex">
        <aside class="w-60 bg-[#252526] flex flex-col flex-shrink-0 border-r border-gray-700/50">
            <div class="flex items-center justify-between p-3 border-b border-gray-700/50"><h3 class="text-sm font-semibold uppercase text-gray-400">Explorer</h3><div class="flex items-center space-x-2"><button id="new-file-btn" class="text-gray-400 hover:text-white" title="New File">+</button><button id="download-zip-btn" class="text-gray-400 hover:text-white" title="Download Project as ZIP"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg></button></div></div>
            <div id="file-explorer" class="text-sm space-y-1 p-2 overflow-y-auto"></div>
        </aside>

        <main class="flex-1 flex flex-col overflow-hidden">
            <div id="top-pane" class="flex-1 flex flex-col min-h-0">
                <div id="tabs-container" class="bg-[#252526] flex-shrink-0 flex items-center border-b border-gray-700/50"></div>
                <div id="editor-container" class="flex-grow relative overflow-hidden"><div id="editor" class="w-full h-full"></div></div>
            </div>
            <div id="resizer" class="h-2 bg-gray-700/50 cursor-ns-resize hover:bg-blue-500 transition-colors duration-200 flex-shrink-0"></div>
            <div id="bottom-pane" class="h-64 flex-shrink-0 flex flex-col bg-[#202124]">
                <div id="bottom-pane-tabs" class="flex items-center space-x-2 px-2 border-b border-gray-700/50 flex-shrink-0"><button data-panel="terminal-panel" class="bottom-tab active-bottom-tab">Terminal</button><button data-panel="chat-panel" class="bottom-tab">Chat</button><button data-panel="participants-panel" class="bottom-tab">Participants</button><button data-panel="video-panel" class="bottom-tab">Video</button><button data-panel="activity-panel" class="bottom-tab">Activity Log</button><div class="flex-grow"></div><button id="run-code-btn" class="flex items-center space-x-1 bg-green-600 hover:bg-green-700 text-white text-xs font-bold py-1 px-3 my-1 rounded"><svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"></path></svg><span>Run</span></button></div>
                <div class="flex-1 p-2 overflow-auto">
                    <div id="terminal-panel" class="bottom-panel h-full flex flex-col"><div class="flex-shrink-0 mb-2"><label for="stdin-input" class="text-xs text-gray-400">Standard Input (stdin)</label><textarea id="stdin-input" rows="3" class="w-full bg-[#3c4043] border border-gray-600 rounded-md px-2 py-1 text-white text-sm focus:outline-none focus:ring-1 focus:ring-blue-500 font-mono"></textarea></div><div id="terminal" class="panel-content-box p-2 text-xs font-mono text-white whitespace-pre-wrap flex-grow"></div></div>
                    <div id="chat-panel" class="bottom-panel h-full hidden flex flex-col"><div id="chat-messages" class="panel-content-box p-2 flex-grow text-sm space-y-2 mb-2 pr-1"></div><input id="chat-input" type="text" placeholder="Type a message and press Enter..." class="w-full bg-[#3c4043] border border-gray-600 rounded-md px-2 py-1 text-white text-sm focus:outline-none focus:ring-1 focus:ring-blue-500"></div>
                    <div id="participants-panel" class="bottom-panel h-full hidden"><div id="participant-list" class="panel-content-box p-2 space-y-2"></div></div>
                    <div id="video-panel" class="bottom-panel h-full hidden flex flex-col">
                        <div id="video-status" class="text-center text-gray-400 text-sm p-4"></div><div id="video-grid" class="panel-content-box p-2 grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2 flex-grow"></div>
                        <div id="video-controls" class="flex-shrink-0 flex items-center justify-center space-x-4 p-2 bg-black/20 rounded-b-md"><button id="toggle-mic-btn" class="p-2 rounded-full bg-gray-600 hover:bg-gray-500"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M5 4a1 1 0 011 1v4a1 1 0 11-2 0V5a1 1 0 011-1zm10 0a1 1 0 011 1v4a1 1 0 11-2 0V5a1 1 0 011-1zM10 2a2 2 0 012 2v8a2 2 0 11-4 0V4a2 2 0 012-2zm-5 8a5 5 0 1010 0V5a5 5 0 10-10 0v5z"></path></svg></button><button id="toggle-cam-btn" class="p-2 rounded-full bg-gray-600 hover:bg-gray-500"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M10 12a2 2 0 100-4 2 2 0 000 4z"></path><path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.022 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"></path></svg></button><button id="share-screen-btn" class="p-2 rounded-full bg-gray-600 hover:bg-gray-500"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg></button></div>
                    </div>
                    <div id="activity-panel" class="bottom-panel h-full hidden flex flex-col"><div id="activity-log" class="panel-content-box p-2 text-sm space-y-1 font-mono"></div></div>
                </div>
            </div>
        </main>
    </div>

    <script>
    const style = document.createElement('style');
    style.innerHTML = `.bottom-tab { @apply px-3 py-2 text-sm text-gray-400 border-b-2 border-transparent transition-colors; } .active-bottom-tab { @apply text-white border-blue-500; }`;
    document.head.appendChild(style);

    document.addEventListener('DOMContentLoaded', () => {
        const socket = io();
        let state = { currentUser: null, currentRoomId: null, username: null, participants: {}, files: {}, openTabs: [], activeTab: null, editorInstance: null, webRTCPeers: {}, localStream: null, screenStream: null, cameraTrack: null, isProgrammaticChange: false, };
        const ui = {
            entryModal: document.getElementById('entry-modal'), usernameInput: document.getElementById('username-input'), createRoomBtn: document.getElementById('create-room-btn'), roomIdInput: document.getElementById('room-id-input'), joinRoomBtn: document.getElementById('join-room-btn'),
            app: document.getElementById('app'), fileExplorer: document.getElementById('file-explorer'), newFileBtn: document.getElementById('new-file-btn'), downloadZipBtn: document.getElementById('download-zip-btn'),
            tabsContainer: document.getElementById('tabs-container'), editorContainer: document.getElementById('editor-container'), topPane: document.getElementById('top-pane'), bottomPane: document.getElementById('bottom-pane'),
            resizer: document.getElementById('resizer'), bottomPaneTabs: document.getElementById('bottom-pane-tabs'),
            runCodeBtn: document.getElementById('run-code-btn'), terminal: document.getElementById('terminal'), stdinInput: document.getElementById('stdin-input'),
            chatMessages: document.getElementById('chat-messages'), chatInput: document.getElementById('chat-input'), participantList: document.getElementById('participant-list'),
            videoGrid: document.getElementById('video-grid'), videoStatus: document.getElementById('video-status'), toggleMicBtn: document.getElementById('toggle-mic-btn'), toggleCamBtn: document.getElementById('toggle-cam-btn'), shareScreenBtn: document.getElementById('share-screen-btn'),
            activityLog: document.getElementById('activity-log'),
        };
        
        const logActivity = (message, icon = '•') => { const logEntry = document.createElement('div'); const timestamp = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }); logEntry.innerHTML = `<span class="text-gray-500">${timestamp}</span> <span class="text-blue-400">${icon}</span> <span>${message}</span>`; ui.activityLog.appendChild(logEntry); ui.activityLog.scrollTop = ui.activityLog.scrollHeight; };
        const init = () => { setupEventListeners(); checkUrlForRoom(); };
        const checkUrlForRoom = () => { const roomId = new URLSearchParams(window.location.search).get('room'); if (roomId) ui.roomIdInput.value = roomId; };
        
        function setupEventListeners() {
            ui.createRoomBtn.addEventListener('click', () => handleJoinAttempt(true)); ui.joinRoomBtn.addEventListener('click', () => handleJoinAttempt(false));
            ui.newFileBtn.addEventListener('click', addNewFile); ui.downloadZipBtn.addEventListener('click', downloadProjectAsZip);
            ui.runCodeBtn.addEventListener('click', runCode); ui.chatInput.addEventListener('keypress', (e) => { if (e.key === 'Enter' && ui.chatInput.value.trim() !== '') { socket.emit('send-chat-message', { message: ui.chatInput.value.trim() }); ui.chatInput.value = ''; } });
            ui.toggleMicBtn.addEventListener('click', toggleMic); ui.toggleCamBtn.addEventListener('click', toggleCam); ui.shareScreenBtn.addEventListener('click', toggleScreenShare);
            setupBottomPanelTabs(); setupResizer();
        }
        
        const setupBottomPanelTabs = () => ui.bottomPaneTabs.addEventListener('click', (e) => { if (e.target.matches('.bottom-tab')) { ui.bottomPaneTabs.querySelector('.active-bottom-tab')?.classList.remove('active-bottom-tab'); e.target.classList.add('active-bottom-tab'); document.querySelectorAll('.bottom-panel').forEach(p => p.classList.add('hidden')); const panel = document.getElementById(e.target.dataset.panel); panel.classList.remove('hidden'); if (['chat-panel', 'video-panel', 'terminal-panel', 'activity-panel'].includes(e.target.dataset.panel)) panel.classList.add('flex', 'flex-col'); } });
        const setupResizer = () => { let isResizing = false; ui.resizer.addEventListener('mousedown', () => { isResizing = true; document.body.style.cursor = 'ns-resize'; document.body.style.userSelect = 'none'; }); document.addEventListener('mousemove', (e) => { if (isResizing) { const totalHeight = ui.app.offsetHeight; const newTopHeight = e.clientY - ui.app.offsetTop; if (newTopHeight > 100 && totalHeight - newTopHeight > 100) { ui.topPane.style.height = `${newTopHeight}px`; ui.bottomPane.style.height = `calc(100% - ${newTopHeight}px - ${ui.resizer.offsetHeight}px)`; } } }); document.addEventListener('mouseup', () => { isResizing = false; document.body.style.cursor = 'default'; document.body.style.userSelect = 'auto'; }); };
        async function handleJoinAttempt(isCreating) { const username = ui.usernameInput.value.trim(); if (!username) return alert('Please enter your name.'); const roomId = isCreating ? `cs-${Math.random().toString(36).substr(2, 9)}` : ui.roomIdInput.value.trim(); if (!roomId) return alert('Please enter a Room ID.'); state.username = username; state.currentRoomId = roomId; ui.entryModal.classList.add('hidden'); ui.app.classList.remove('hidden'); ui.app.classList.add('flex'); window.history.pushState(null, '', `?room=${roomId}`); await initializeMedia(); if (socket.connected) socket.emit('join-room', { roomId: state.currentRoomId, username: state.username }); }
        const renderFileExplorer = () => { ui.fileExplorer.innerHTML = Object.keys(state.files).sort().map(path => `<div class="flex justify-between items-center group p-1 rounded hover:bg-white/10 cursor-pointer" data-path="${path}"><span class="file-name text-gray-300 group-hover:text-white">${path}</span><div class="hidden group-hover:flex items-center"><button class="rename-file-btn text-xs text-gray-400 hover:text-white mr-1" data-path="${path}">✏️</button><button class="delete-file-btn text-xs text-gray-400 hover:text-white" data-path="${path}">🗑️</button></div></div>`).join(''); ui.fileExplorer.querySelectorAll('[data-path]').forEach(el => el.addEventListener('click', (e) => !e.target.closest('button') && openTab(el.dataset.path))); ui.fileExplorer.querySelectorAll('.rename-file-btn').forEach(btn => btn.addEventListener('click', renameFile)); ui.fileExplorer.querySelectorAll('.delete-file-btn').forEach(btn => btn.addEventListener('click', deleteFile)); };
        const renderParticipants = () => { const participants = Object.values(state.participants); const avatar = (p) => `<div class="w-8 h-8 rounded-full flex-shrink-0 flex items-center justify-center text-sm font-bold" style="background-color: ${p.color}; color: #fff;">${p.username.charAt(0).toUpperCase()}</div>`; ui.participantList.innerHTML = participants.map(p => `<div class="flex items-center space-x-3 p-2 rounded-md hover:bg-white/5">${avatar(p)}<span class="font-medium">${p.username} ${p.id === state.currentUser?.id ? '<span class="text-xs text-blue-400">(You)</span>' : ''}</span></div>`).join(''); };
        const renderTabs = () => { ui.tabsContainer.innerHTML = state.openTabs.map(path => `<div class="tab flex items-center px-4 py-2 border-r border-gray-700/50 cursor-pointer ${path === state.activeTab ? 'bg-[#1e1e1e]' : 'bg-transparent hover:bg-white/5'}" data-path="${path}"><span class="text-sm">${path}</span><button class="close-tab-btn ml-3 text-gray-400 hover:text-white" data-path="${path}">×</button></div>`).join(''); ui.tabsContainer.querySelectorAll('.tab').forEach(tab => tab.addEventListener('click', (e) => !e.target.classList.contains('close-tab-btn') && switchTab(tab.dataset.path))); ui.tabsContainer.querySelectorAll('.close-tab-btn').forEach(btn => btn.addEventListener('click', (e) => { e.stopPropagation(); closeTab(btn.dataset.path); })); };
        const addNewFile = () => { const path = prompt("Enter new file name:"); if (path && !state.files[path]) socket.emit('file-add', { path }); else if (state.files[path]) alert('A file with that name already exists.'); };
        const renameFile = (e) => { const oldPath = e.target.dataset.path; const newPath = prompt("Enter new file name:", oldPath); if (newPath && newPath !== oldPath && !state.files[newPath]) socket.emit('file-rename', { oldPath, newPath }); else if (state.files[newPath]) alert('A file with that name already exists.'); };
        const deleteFile = (e) => { const path = e.target.dataset.path; if (confirm(`Delete ${path}?`)) socket.emit('file-delete', { path }); };
        const openTab = (path) => { if (!state.openTabs.includes(path)) state.openTabs.push(path); switchTab(path); };
        const closeTab = (path) => { state.openTabs = state.openTabs.filter(t => t !== path); if (state.activeTab === path) { state.activeTab = state.openTabs[0] || null; updateEditorContent(state.activeTab); } renderTabs(); };
        const switchTab = (path) => { state.activeTab = path; renderTabs(); updateEditorContent(path); };
        
        function initializeEditor() {
            if (state.editorInstance) return;
            const editorDiv = document.getElementById('editor');
            require.config({ paths: { 'vs': 'https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs' }});
            require(['vs/editor/editor.main'], function () {
                state.editorInstance = monaco.editor.create(editorDiv, {
                    value: "// Welcome to Code Stream!", language: 'javascript', theme: 'vs',
                    automaticLayout: true, fontSize: 14,
                });
                
                state.editorInstance.onDidChangeModelContent(e => {
                    if (state.isProgrammaticChange) return;
                    const newCode = state.editorInstance.getValue();
                    state.files[state.activeTab] = newCode;
                    const PASTE_THRESHOLD = 50;
                    const isPaste = e.changes.length === 1 && e.changes[0].text.length > PASTE_THRESHOLD;
                    if (isPaste) socket.emit('large-paste');
                    socket.emit('code-change', { path: state.activeTab, newCode: newCode });
                });

                const firstFile = Object.keys(state.files)[0];
                if (firstFile) openTab(firstFile);
            });
        }

        const getLanguageFromPath = (path) => { const ext = path?.split('.').pop() || ''; return { 'js': 'javascript', 'py': 'python', 'java': 'java', 'c': 'c', 'cpp': 'cpp', 'html': 'html', 'css': 'css' }[ext] || 'plaintext'; };
        const updateEditorContent = (path) => { if (!state.editorInstance) return; if (!path) { state.editorInstance.setValue(''); return; } const model = state.editorInstance.getModel(); state.isProgrammaticChange = true; model.setValue(state.files[path] || ''); monaco.editor.setModelLanguage(model, getLanguageFromPath(path)); state.isProgrammaticChange = false; };
        const runCode = () => { if (!state.activeTab) return alert('Open a file to run.'); const lang = { 'js': 'javascript', 'py': 'python', 'java': 'java', 'c': 'c', 'cpp': 'cpp' }[state.activeTab.split('.').pop()]; if (!lang) return alert(`Execution for .${state.activeTab.split('.').pop()} files is not supported.`); ui.terminal.innerHTML += `<span class="text-blue-400">> Executing ${state.activeTab}...</span>\n`; socket.emit('run-code', { language: lang, code: state.editorInstance.getValue(), currentFile: state.activeTab, stdin: ui.stdinInput.value }); };
        const downloadProjectAsZip = () => { const zip = new JSZip(); Object.keys(state.files).forEach(path => zip.file(path, state.files[path])); zip.generateAsync({ type: "blob" }).then(content => { const link = document.createElement('a'); link.href = URL.createObjectURL(content); link.download = `code-stream-${state.currentRoomId}.zip`; link.click(); }); };
        async function initializeMedia() { try { ui.videoStatus.textContent = "Initializing camera..."; state.localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true }); console.log("Local stream acquired."); state.cameraTrack = state.localStream.getVideoTracks()[0]; const localVideo = document.createElement('video'); localVideo.srcObject = state.localStream; localVideo.autoplay = true; localVideo.muted = true; localVideo.className = 'w-full h-auto bg-black rounded'; ui.videoGrid.prepend(localVideo); ui.videoStatus.textContent = "Waiting for other participants..."; } catch (error) { console.error("Could not get user media", error); ui.videoStatus.textContent = "Camera/Mic access denied. Video chat is disabled."; logActivity("Camera/Mic access denied.", '🚫'); } }
        const toggleMic = () => { if (!state.localStream) return; const enabled = !state.localStream.getAudioTracks()[0].enabled; state.localStream.getAudioTracks()[0].enabled = enabled; ui.toggleMicBtn.classList.toggle('bg-red-600', !enabled); ui.toggleMicBtn.classList.toggle('bg-gray-600', enabled); };
        const toggleCam = () => { if (!state.cameraTrack) return; const enabled = !state.cameraTrack.enabled; state.cameraTrack.enabled = enabled; ui.toggleCamBtn.classList.toggle('bg-red-600', !enabled); ui.toggleCamBtn.classList.toggle('bg-gray-600', enabled); };
        async function toggleScreenShare() { if (state.screenStream) { await stopScreenShare(); } else { try { state.screenStream = await navigator.mediaDevices.getDisplayMedia({ video: true }); const screenTrack = state.screenStream.getVideoTracks()[0]; await replaceTrackForAllPeers(screenTrack); ui.shareScreenBtn.classList.add('bg-blue-600'); screenTrack.onended = () => stopScreenShare(); } catch(err) { console.error("Screen share error:", err); logActivity("Could not start screen share.", '🖥️');} } }
        async function stopScreenShare() { if (!state.cameraTrack) return; await replaceTrackForAllPeers(state.cameraTrack); state.screenStream.getTracks().forEach(track => track.stop()); state.screenStream = null; ui.shareScreenBtn.classList.remove('bg-blue-600'); };
        const replaceTrackForAllPeers = async (newTrack) => { for (const peerId in state.webRTCPeers) { const sender = state.webRTCPeers[peerId].getSenders().find(s => s.track?.kind === 'video'); if (sender) await sender.replaceTrack(newTrack); } };
        const createPeerConnection = (remoteUserId) => { console.log(`Creating peer connection to ${remoteUserId}`); const pc = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] }); pc.onicecandidate = e => e.candidate && socket.emit('webrtc-ice-candidate', { to: remoteUserId, candidate: e.candidate }); pc.ontrack = e => { console.log(`Received track from ${remoteUserId}`); let videoContainer = document.getElementById(`video-container-${remoteUserId}`); if (!videoContainer) { videoContainer = document.createElement('div'); videoContainer.id = `video-container-${remoteUserId}`; videoContainer.className = 'relative'; videoContainer.innerHTML = `<video id="video-${remoteUserId}" autoplay class="w-full h-auto bg-black rounded"></video>`; ui.videoGrid.appendChild(videoContainer); ui.videoStatus.textContent = ""; } document.getElementById(`video-${remoteUserId}`).srcObject = e.streams[0]; }; state.localStream?.getTracks().forEach(track => pc.addTrack(track, state.localStream)); state.webRTCPeers[remoteUserId] = pc; return pc; };
        
        socket.on('connect', () => { if (state.currentRoomId && state.username) socket.emit('join-room', { roomId: state.currentRoomId, username: state.username }); });
        
        socket.on('initial-sync', (data) => {
            const isFirstSync = !state.editorInstance;
            Object.assign(state, data);
            renderFileExplorer();
            renderParticipants();
            if (isFirstSync) {
                initializeEditor();
            }
        });
        
        socket.on('user-joined', ({ user }) => { state.participants[user.id] = user; renderParticipants(); logActivity(`${user.username} has joined.`, '➡️'); if (state.localStream) { const pc = createPeerConnection(user.id); pc.createOffer().then(offer => { pc.setLocalDescription(offer); socket.emit('webrtc-offer', { to: user.id, offer }); }); } });
        socket.on('user-left', ({ userId }) => { const user = state.participants[userId]; if (user) logActivity(`${user.username} has left.`, '⬅️'); delete state.participants[userId]; renderParticipants(); state.webRTCPeers[userId]?.close(); delete state.webRTCPeers[userId]; document.getElementById(`video-container-${userId}`)?.remove(); if(Object.keys(state.participants).length <= 1) ui.videoStatus.textContent = "Waiting for other participants..."; });
        socket.on('file-add', ({ path }) => { state.files[path] = ''; renderFileExplorer(); });
        socket.on('file-rename', ({ oldPath, newPath }) => { state.files[newPath] = state.files[oldPath]; delete state.files[oldPath]; const tabIndex = state.openTabs.indexOf(oldPath); if (tabIndex > -1) state.openTabs[tabIndex] = newPath; if (state.activeTab === oldPath) state.activeTab = newPath; renderFileExplorer(); renderTabs(); });
        socket.on('file-delete', ({ path }) => { delete state.files[path]; if (state.activeTab === path) closeTab(path); else { state.openTabs = state.openTabs.filter(t => t !== path); renderTabs(); } renderFileExplorer(); });
        
        socket.on('code-change', ({ path, newCode }) => {
            state.files[path] = newCode;
            if (path === state.activeTab && state.editorInstance) {
                const model = state.editorInstance.getModel();
                if (model.getValue() !== newCode) {
                    const currentPosition = state.editorInstance.getPosition();
                    state.isProgrammaticChange = true;
                    model.setValue(newCode);
                    state.editorInstance.setPosition(currentPosition);
                    state.isProgrammaticChange = false;
                }
            }
        });

        socket.on('code-output', ({ stdout, stderr, status }) => { let outputHTML = ''; if (stderr) outputHTML += `<span class="text-orange-400">${stderr.replace(/\n/g, '<br>')}</span>`; else if (stdout) outputHTML += `<span class="text-gray-300">Output:\n${stdout.replace(/\n/g, '<br>')}</span>`; else outputHTML += `<span class="text-gray-500">Execution finished with status: ${status}</span>`; ui.terminal.innerHTML += outputHTML + '\n'; ui.terminal.scrollTop = ui.terminal.scrollHeight; });
        socket.on('execution-notification', ({ username, file }) => logActivity(`${username} ran ${file}`, '🧑‍💻'));
        socket.on('paste-notification', ({ username }) => logActivity(`${username} pasted a large block of code.`, '📋'));
        socket.on('receive-chat-message', ({ user, message }) => { const messageEl = document.createElement('div'); messageEl.innerHTML = `<div><b style="color:${user.color};">${user.username}:</b> <span class="text-gray-300">${message}</span></div>`; ui.chatMessages.appendChild(messageEl); ui.chatMessages.scrollTop = ui.chatMessages.scrollHeight; });
        socket.on('webrtc-offer', async ({ from, offer }) => { const pc = createPeerConnection(from); await pc.setRemoteDescription(new RTCSessionDescription(offer)); const answer = await pc.createAnswer(); await pc.setLocalDescription(answer); socket.emit('webrtc-answer', { to: from, answer }); });
        socket.on('webrtc-answer', ({ from, answer }) => state.webRTCPeers[from]?.setRemoteDescription(new RTCSessionDescription(answer)));
        socket.on('webrtc-ice-candidate', ({ from, candidate }) => state.webRTCPeers[from]?.addIceCandidate(new RTCIceCandidate(candidate)));
        
        init();
    });
    </script>
</body>
</html>
